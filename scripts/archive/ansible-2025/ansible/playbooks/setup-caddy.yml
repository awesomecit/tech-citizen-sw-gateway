---
# Caddy Setup Playbook - Configure reverse proxy with SSL/TLS
# Usage: ansible-playbook -i inventory/hosts.ini playbooks/setup-caddy.yml --limit=production

- name: Setup Caddy Reverse Proxy with SSL
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    caddy_log_dir: /var/log/caddy

  pre_tasks:
    - name: Set domain from environment if not defined
      set_fact:
        domain: "{{ lookup('env', 'DOMAIN') | default('tech-citizen.me', true) }}"
      when: domain is not defined

    - name: Set environment from group_vars or default
      set_fact:
        environment: "{{ environment | default('production') }}"

    - name: Set infrastructure_dir
      set_fact:
        infrastructure_dir: /opt/gateway/infrastructure

    - name: Set caddy_config_dir
      set_fact:
        caddy_config_dir: '{{ infrastructure_dir }}/caddy'

    - name: Set subdomains
      set_fact:
        gateway_domain: 'gateway.{{ domain }}'
        auth_domain: 'auth.{{ domain }}'
        grafana_domain: 'grafana.{{ domain }}'
        app_domain: 'app.{{ domain }}'
        www_domain: 'www.{{ domain }}'

    - name: Set SSL email
      set_fact:
        ssl_email: "{{ lookup('env', 'SSL_EMAIL') | default('admin@' + domain, true) }}"

    - name: Set ssl_staging
      set_fact:
        ssl_staging: false

    - name: Set service ports
      set_fact:
        gateway_port: 3042
        keycloak_port: 8090
        grafana_port: 3001
        prometheus_port: 19090
        caddy_http_port: 80
        caddy_https_port: 443
        caddy_admin_port: 2019

  tasks:
    - name: Print Caddy setup banner
      debug:
        msg: |
          ================================================
          Caddy Reverse Proxy Setup
          ================================================
          Environment: {{ environment }}
          Domain: {{ domain }}
          Gateway: {{ gateway_domain }}
          Auth: {{ auth_domain }}
          Grafana: {{ grafana_domain }}
          {% if environment == 'production' %}
          App: {{ app_domain }}
          WWW: {{ www_domain }}
          {% endif %}
          SSL Email: {{ ssl_email }}
          SSL Staging: {{ ssl_staging }}
          ================================================

    - name: Create Caddy config directory
      file:
        path: '{{ caddy_config_dir }}'
        state: directory
        mode: '0755'

    - name: Create Caddy log directory
      file:
        path: '{{ caddy_log_dir }}'
        state: directory
        mode: '0755'

    - name: Generate Caddyfile from template
      template:
        src: templates/Caddyfile.j2
        dest: '{{ caddy_config_dir }}/Caddyfile'
        mode: '0644'
      register: caddyfile_changed

    - name: Validate Caddyfile syntax
      command: docker run --rm -v {{ caddy_config_dir }}:/etc/caddy:ro caddy:2-alpine caddy validate --config /etc/caddy/Caddyfile
      when: caddyfile_changed.changed
      register: validation_result
      failed_when: validation_result.rc != 0

    - name: Reload Caddy if configuration changed
      command: docker exec gateway-caddy caddy reload --config /etc/caddy/Caddyfile
      when:
        - caddyfile_changed.changed
        - validation_result.rc == 0
      ignore_errors: yes
      register: reload_result

    - name: Restart Caddy if reload failed
      command: docker restart gateway-caddy
      when:
        - caddyfile_changed.changed
        - reload_result.failed | default(false)

    - name: Wait for Caddy to be healthy
      uri:
        url: 'http://localhost:80/health'
        status_code: 200
      register: health_check
      retries: 10
      delay: 3
      until: health_check.status == 200

    - name: Print Caddy status
      debug:
        msg: |
          âœ“ Caddy configured successfully

          Configuration: {{ caddy_config_dir }}/Caddyfile
          Health endpoint: http://localhost:80/health
          Admin API: http://localhost:2019

          Public URLs (after DNS propagation):
          - https://{{ domain }}
          - https://{{ www_domain }}
          - https://{{ gateway_domain }}
          - https://{{ auth_domain }}
          - https://{{ grafana_domain }}
          {% if environment == 'production' %}
          - https://{{ app_domain }}
          {% endif %}

          Next steps:
          1. Configure DNS records (see docs/operations/PRODUCTION_STATUS.md)
          2. Wait 5-10 minutes for SSL certificates
          3. Test: curl https://{{ gateway_domain }}/health
