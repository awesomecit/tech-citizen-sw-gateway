---
# Playbook 2: Check & Install Dependencies
# Purpose: Verify/install Docker and Docker Compose
# Idempotent: Skips if already installed

- name: Check & Install Dependencies
  hosts: all
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Set environment from group_vars or default
      set_fact:
        deploy_env: "{{ deploy_env | default('production') }}"

    - name: Print dependencies check banner
      debug:
        msg: |
          ================================================
          Dependencies Check - {{ deploy_env | upper }}
          ================================================
          Checking: Docker, Docker Compose
          ================================================

  tasks:
    - name: Check if Docker is installed
      command: docker --version
      register: docker_version_check
      changed_when: false
      failed_when: false

    - name: Check if Docker Compose is installed
      command: docker compose version
      register: docker_compose_check
      changed_when: false
      failed_when: false

    - name: Print current Docker status
      debug:
        msg: |
          Docker installed: {{ docker_version_check.rc == 0 }}
          {% if docker_version_check.rc == 0 %}
          Version: {{ docker_version_check.stdout }}
          {% endif %}
          Docker Compose installed: {{ docker_compose_check.rc == 0 }}
          {% if docker_compose_check.rc == 0 %}
          Version: {{ docker_compose_check.stdout }}
          {% endif %}

    # Install Docker only if not present
    - name: Install Docker prerequisites
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
      when: docker_version_check.rc != 0

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      when: docker_version_check.rc != 0

    - name: Download Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      when: docker_version_check.rc != 0

    - name: Add Docker repository
      shell: |
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list
      when: docker_version_check.rc != 0

    - name: Update apt cache after adding Docker repo
      apt:
        update_cache: yes
      when: docker_version_check.rc != 0

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
      when: docker_version_check.rc != 0

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
      when: docker_version_check.rc != 0

    # Verify installation
    - name: Verify Docker installation
      command: docker --version
      register: docker_final_check
      changed_when: false

    - name: Verify Docker Compose installation
      command: docker compose version
      register: compose_final_check
      changed_when: false

    - name: Print final status
      debug:
        msg: |
          âœ“ Dependencies verified

          Docker: {{ docker_final_check.stdout }}
          Docker Compose: {{ compose_final_check.stdout }}

          {% if docker_version_check.rc != 0 %}
          Action: Installed Docker and Docker Compose
          {% else %}
          Action: Dependencies already satisfied (skipped installation)
          {% endif %}
