---
# Playbook 3: Prepare Directories
# Purpose: Create deployment directory structure based on environment
# Idempotent: Safe to run multiple times

- name: Prepare Deployment Directories
  hosts: all
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Set environment from group_vars or default
      set_fact:
        deploy_env: "{{ deploy_env | default('production') }}"

    - name: Set deployment root based on environment
      set_fact:
        deployment_root: "{{ '/opt/gateway' if deploy_env == 'production' else '/opt/gateway-' + deploy_env }}"

    - name: Set infrastructure directory
      set_fact:
        infrastructure_dir: '{{ deployment_root }}/infrastructure'

    - name: Print directory preparation banner
      debug:
        msg: |
          ================================================
          Directory Preparation - {{ deploy_env | upper }}
          ================================================
          Root: {{ deployment_root }}
          Infrastructure: {{ infrastructure_dir }}
          ================================================

  tasks:
    - name: Create deployment root directory
      file:
        path: '{{ deployment_root }}'
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Create infrastructure subdirectories
      file:
        path: '{{ item }}'
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop:
        - '{{ infrastructure_dir }}'
        - '{{ infrastructure_dir }}/caddy'
        - '{{ infrastructure_dir }}/prometheus'
        - '{{ infrastructure_dir }}/grafana'
        - '{{ infrastructure_dir }}/keycloak'
        - '{{ infrastructure_dir }}/loki'

    - name: Create log directory
      file:
        path: '{{ deployment_root }}/logs'
        state: directory
        mode: '0755'

    - name: Create backup directory
      file:
        path: /root/backups
        state: directory
        mode: '0700'

    - name: Create marker file with deployment info
      copy:
        dest: '{{ deployment_root }}/.deployment-info'
        content: |
          environment={{ deploy_env }}
          deployed_at={{ ansible_date_time.iso8601 }}
          deployed_by={{ lookup('env', 'USER') }}
          ansible_version={{ ansible_version.full }}
        mode: '0644'

    - name: Print completion message
      debug:
        msg: |
          ✓ Directories prepared

          Structure created:
          {{ deployment_root }}/
          ├── infrastructure/
          │   ├── caddy/
          │   ├── prometheus/
          │   ├── grafana/
          │   ├── keycloak/
          │   └── loki/
          ├── logs/
          └── .deployment-info

          Backup directory: /root/backups
