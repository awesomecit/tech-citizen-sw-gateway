[
  {
    "description": "  As a developer\n  I want to validate JWT tokens from Keycloak\n  So that only authenticated users access protected resources",
    "elements": [
      {
        "description": "",
        "id": "jwt-validation-plugin;valid-jwt-token-authentication",
        "keyword": "Scenario",
        "line": 11,
        "name": "Valid JWT token authentication",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists with public key",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "the auth package is registered in a Fastify app",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "sub",
                      "user-123"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "test@example.com"
                    ]
                  },
                  {
                    "cells": [
                      "exp",
                      "2025-12-10T00:00:00Z"
                    ]
                  },
                  {
                    "cells": [
                      "iss",
                      "http://localhost:8080/realms/techcitizen"
                    ]
                  }
                ]
              }
            ],
            "keyword": "Given ",
            "line": 12,
            "name": "a valid JWT signed by Keycloak with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 18,
            "name": "I call fastify.authenticate(request, reply)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 19,
            "name": "the authentication succeeds",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 20,
            "name": "request.user.sub equals \"user-123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 21,
            "name": "request.user.email equals \"test@example.com\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 22,
            "name": "no error is thrown",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "jwt-validation-plugin;expired-jwt-token",
        "keyword": "Scenario",
        "line": 24,
        "name": "Expired JWT token",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists with public key",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "the auth package is registered in a Fastify app",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "sub",
                      "user-123"
                    ]
                  },
                  {
                    "cells": [
                      "exp",
                      "2025-12-08T00:00:00Z"
                    ]
                  }
                ]
              }
            ],
            "keyword": "Given ",
            "line": 25,
            "name": "a JWT signed by Keycloak with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 29,
            "name": "I call fastify.authenticate(request, reply)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 30,
            "name": "the authentication fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 31,
            "name": "reply status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 32,
            "name": "error type is \"TokenExpiredError\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 33,
            "name": "error message contains \"jwt expired\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "jwt-validation-plugin;invalid-jwt-signature",
        "keyword": "Scenario",
        "line": 35,
        "name": "Invalid JWT signature",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists with public key",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "the auth package is registered in a Fastify app",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 36,
            "name": "a JWT with tampered signature",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 37,
            "name": "I call fastify.authenticate(request, reply)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 38,
            "name": "the authentication fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 39,
            "name": "reply status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 40,
            "name": "error type is \"JsonWebTokenError\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 41,
            "name": "error message contains \"invalid signature\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "jwt-validation-plugin;missing-jwt-token",
        "keyword": "Scenario",
        "line": 43,
        "name": "Missing JWT token",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists with public key",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "the auth package is registered in a Fastify app",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 44,
            "name": "no Authorization header in request",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 45,
            "name": "I call fastify.authenticate(request, reply)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 46,
            "name": "the authentication fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 47,
            "name": "reply status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 48,
            "name": "error message contains \"No Authorization was found in request.headers\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "jwt-validation-plugin;malformed-jwt-token",
        "keyword": "Scenario",
        "line": 50,
        "name": "Malformed JWT token",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists with public key",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "the auth package is registered in a Fastify app",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 51,
            "name": "Authorization header \"Bearer not-a-valid-jwt\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 52,
            "name": "I call fastify.authenticate(request, reply)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 53,
            "name": "the authentication fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 54,
            "name": "reply status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 55,
            "name": "error type is \"JsonWebTokenError\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 56,
            "name": "error message contains \"jwt malformed\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "jwt-validation-plugin;wrong-issuer-in-jwt",
        "keyword": "Scenario",
        "line": 58,
        "name": "Wrong issuer in JWT",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists with public key",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "the auth package is registered in a Fastify app",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "iss",
                      "http://evil.com/realms/fake"
                    ]
                  }
                ]
              }
            ],
            "keyword": "Given ",
            "line": 59,
            "name": "a valid JWT signed by different issuer:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 62,
            "name": "I call fastify.authenticate(request, reply)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 63,
            "name": "the authentication fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 64,
            "name": "reply status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 65,
            "name": "error message contains \"invalid issuer\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "jwt-validation-plugin;jwt-with-missing-required-claims",
        "keyword": "Scenario",
        "line": 67,
        "name": "JWT with missing required claims",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists with public key",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "the auth package is registered in a Fastify app",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 68,
            "name": "a JWT missing the \"sub\" claim",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 69,
            "name": "I call fastify.authenticate(request, reply)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 70,
            "name": "the authentication fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 71,
            "name": "reply status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 72,
            "name": "error message contains \"missing required claim: sub\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      }
    ],
    "id": "jwt-validation-plugin",
    "line": 1,
    "keyword": "Feature",
    "name": "JWT Validation Plugin",
    "tags": [],
    "uri": "e2e/features/auth-jwt-validation.feature"
  },
  {
    "description": "  As a developer\n  I want to manage users in Keycloak programmatically\n  So that I can handle registration, login, and user lifecycle",
    "elements": [
      {
        "description": "",
        "id": "keycloak-user-management-integration;create-new-user-successfully",
        "keyword": "Scenario",
        "line": 12,
        "name": "Create new user successfully",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 13,
            "name": "no user exists with email \"newuser@example.com\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "newuser@example.com"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "SecureP@ss123"
                    ]
                  },
                  {
                    "cells": [
                      "enabled",
                      "true"
                    ]
                  }
                ]
              }
            ],
            "keyword": "When ",
            "line": 14,
            "name": "I call keycloak.createUser with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 19,
            "name": "the user is created in Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 20,
            "name": "the user ID is returned",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 21,
            "name": "the user can login with credentials \"newuser@example.com\" and \"SecureP@ss123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 22,
            "name": "the user's email is verified",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-user-management-integration;attempt-to-create-duplicate-user",
        "keyword": "Scenario",
        "line": 24,
        "name": "Attempt to create duplicate user",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 25,
            "name": "a user exists with email \"existing@example.com\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "existing@example.com"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "AnotherP@ss456"
                    ]
                  }
                ]
              }
            ],
            "keyword": "When ",
            "line": 26,
            "name": "I call keycloak.createUser with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 30,
            "name": "an error is thrown",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 31,
            "name": "error code is \"USER_EXISTS\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 32,
            "name": "error message contains \"User with email existing@example.com already exists\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 33,
            "name": "the original user remains unchanged",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-user-management-integration;find-user-by-email",
        "keyword": "Scenario",
        "line": 35,
        "name": "Find user by email",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "findme@example.com"
                    ]
                  },
                  {
                    "cells": [
                      "userId",
                      "user-456"
                    ]
                  },
                  {
                    "cells": [
                      "username",
                      "findme"
                    ]
                  }
                ]
              }
            ],
            "keyword": "Given ",
            "line": 36,
            "name": "a user exists with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 41,
            "name": "I call keycloak.findUserByEmail(\"findme@example.com\")",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 42,
            "name": "the user object is returned",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 43,
            "name": "user.id equals \"user-456\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 44,
            "name": "user.email equals \"findme@example.com\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 45,
            "name": "user.username equals \"findme\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-user-management-integration;find-non-existent-user-returns-null",
        "keyword": "Scenario",
        "line": 47,
        "name": "Find non-existent user returns null",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 48,
            "name": "no user exists with email \"ghost@example.com\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 49,
            "name": "I call keycloak.findUserByEmail(\"ghost@example.com\")",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 50,
            "name": "null is returned",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 51,
            "name": "no error is thrown",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-user-management-integration;update-user-password",
        "keyword": "Scenario",
        "line": 53,
        "name": "Update user password",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 54,
            "name": "a user exists with email \"resetme@example.com\" and password \"OldP@ss123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 55,
            "name": "I call keycloak.updatePassword(\"resetme@example.com\", \"NewP@ss456\")",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 56,
            "name": "the password is updated successfully",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 57,
            "name": "the user cannot login with password \"OldP@ss123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 58,
            "name": "the user can login with password \"NewP@ss456\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-user-management-integration;delete-user",
        "keyword": "Scenario",
        "line": 60,
        "name": "Delete user",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 61,
            "name": "a user exists with email \"deleteme@example.com\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 62,
            "name": "I call keycloak.deleteUser(\"deleteme@example.com\")",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 63,
            "name": "the user is removed from Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 64,
            "name": "subsequent findUserByEmail returns null",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 65,
            "name": "the user cannot login",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-user-management-integration;keycloak-connection-failure-with-retry",
        "keyword": "Scenario",
        "line": 67,
        "name": "Keycloak connection failure with retry",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 68,
            "name": "Keycloak container is stopped",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 69,
            "name": "I call keycloak.createUser with any data",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 70,
            "name": "the plugin retries 3 times",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 71,
            "name": "each retry has exponential backoff (1s, 2s, 4s)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 72,
            "name": "after 3 retries, error is thrown",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 73,
            "name": "error code is \"SERVICE_UNAVAILABLE\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 74,
            "name": "error message contains \"Keycloak is unavailable after 3 retries\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-user-management-integration;keycloak-authentication-failure-(invalid-credentials)",
        "keyword": "Scenario",
        "line": 76,
        "name": "Keycloak authentication failure (invalid credentials)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 77,
            "name": "Keycloak is running",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "But ",
            "line": 78,
            "name": "admin credentials are invalid",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 79,
            "name": "I initialize the keycloak plugin",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 80,
            "name": "an error is thrown",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 81,
            "name": "error code is \"AUTH_FAILED\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 82,
            "name": "error message contains \"Invalid admin credentials for Keycloak\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-user-management-integration;create-user-with-custom-attributes",
        "keyword": "Scenario",
        "line": 84,
        "name": "Create user with custom attributes",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "realm \"techcitizen\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "I have admin credentials for Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "the auth package keycloak plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 85,
            "name": "no user exists with email \"custom@example.com\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "custom@example.com"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "SecureP@ss123"
                    ]
                  },
                  {
                    "cells": [
                      "attributes.role",
                      "patient"
                    ]
                  },
                  {
                    "cells": [
                      "attributes.clinic",
                      "clinic-789"
                    ]
                  }
                ]
              }
            ],
            "keyword": "When ",
            "line": 86,
            "name": "I call keycloak.createUser with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 92,
            "name": "the user is created with custom attributes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 93,
            "name": "user.attributes.role equals [\"patient\"]",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 94,
            "name": "user.attributes.clinic equals [\"clinic-789\"]",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      }
    ],
    "id": "keycloak-user-management-integration",
    "line": 1,
    "keyword": "Feature",
    "name": "Keycloak User Management Integration",
    "tags": [],
    "uri": "e2e/features/auth-keycloak-integration.feature"
  },
  {
    "description": "  Come utente del sistema\n  Voglio autenticarmi tramite Keycloak\n  Per accedere alle risorse protette",
    "elements": [
      {
        "description": "",
        "id": "login-e-gestione-sessioni-utente;login-con-credenziali-valide",
        "keyword": "Scenario",
        "line": 13,
        "name": "Login con credenziali valide",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che Keycloak  configurato con realm \"test\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:81"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che esiste un utente \"testuser\" con password \"testpass\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:102"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 14,
            "name": "l'utente effettua login con username \"testuser\" e password \"testpass\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:149"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 15,
            "name": "il login ha successo",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:204"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 16,
            "name": "riceve un access token valido",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:212"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 17,
            "name": "riceve un refresh token valido",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:219"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 18,
            "name": "la sessione viene salvata in Redis",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:226"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "login-e-gestione-sessioni-utente;login-con-credenziali-invalide",
        "keyword": "Scenario",
        "line": 20,
        "name": "Login con credenziali invalide",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che Keycloak  configurato con realm \"test\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:81"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che esiste un utente \"testuser\" con password \"testpass\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:102"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 21,
            "name": "l'utente effettua login con username \"testuser\" e password \"wrong\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:149"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 22,
            "name": "il login fallisce",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:208"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 23,
            "name": "riceve un errore 401",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:233"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 24,
            "name": "non viene creata alcuna sessione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:237"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "login-e-gestione-sessioni-utente;accesso-a-risorsa-protetta-con-token-valido",
        "keyword": "Scenario",
        "line": 26,
        "name": "Accesso a risorsa protetta con token valido",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che Keycloak  configurato con realm \"test\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:81"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che esiste un utente \"testuser\" con password \"testpass\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:102"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 27,
            "name": "che l'utente ha effettuato login",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:131"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 28,
            "name": "l'utente accede a \"/api/protected\" con il token",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:185"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 29,
            "name": "la richiesta ha successo",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:242"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 30,
            "name": "riceve status 200",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:250"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "login-e-gestione-sessioni-utente;accesso-a-risorsa-protetta-senza-token",
        "keyword": "Scenario",
        "line": 32,
        "name": "Accesso a risorsa protetta senza token",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che Keycloak  configurato con realm \"test\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:81"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che esiste un utente \"testuser\" con password \"testpass\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:102"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 33,
            "name": "l'utente accede a \"/api/protected\" senza token",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:196"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 34,
            "name": "la richiesta fallisce",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:246"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 35,
            "name": "riceve status 401",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:250"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 36,
            "name": "riceve messaggio \"Missing or invalid token\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:254"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      }
    ],
    "id": "login-e-gestione-sessioni-utente",
    "line": 2,
    "keyword": "Funzionalit",
    "name": "Login e gestione sessioni utente",
    "tags": [],
    "uri": "e2e/features/auth-login.feature"
  },
  {
    "description": "  As a developer\n  I want to register the auth plugin in Fastify apps\n  So that I can reuse authentication logic across services",
    "elements": [
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;register-plugin-with-routes-enabled-(auth-api-mode)",
        "keyword": "Scenario",
        "line": 11,
        "name": "Register plugin with routes enabled (auth-api mode)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 12,
            "name": "a Fastify app for auth-api service",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"keycloakUrl\": \"http://localhost:8080\",\n  \"realm\": \"techcitizen\",\n  \"clientId\": \"auth-api\",\n  \"clientSecret\": \"secret-123\",\n  \"redisUrl\": \"redis://localhost:6379\",\n  \"enableRoutes\": true\n}",
                "line": 14
              }
            ],
            "keyword": "When ",
            "line": 13,
            "name": "I register @tech-citizen/auth plugin with options:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 24,
            "name": "the plugin registers successfully",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 25,
            "name": "route POST /auth/register exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 26,
            "name": "route POST /auth/login exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 27,
            "name": "route POST /auth/logout exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 28,
            "name": "route POST /auth/refresh exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 29,
            "name": "route GET /auth/me exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 30,
            "name": "decorator \"authenticate\" is available",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 31,
            "name": "decorator \"keycloak\" is available",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 32,
            "name": "decorator \"session\" is available",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;register-plugin-without-routes-(gateway-mode)",
        "keyword": "Scenario",
        "line": 34,
        "name": "Register plugin without routes (gateway mode)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 35,
            "name": "a Fastify app for gateway service",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"keycloakUrl\": \"http://localhost:8080\",\n  \"realm\": \"techcitizen\",\n  \"clientId\": \"gateway\",\n  \"clientSecret\": \"secret-456\",\n  \"redisUrl\": \"redis://localhost:6379\",\n  \"enableRoutes\": false\n}",
                "line": 37
              }
            ],
            "keyword": "When ",
            "line": 36,
            "name": "I register @tech-citizen/auth plugin with options:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 47,
            "name": "the plugin registers successfully",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 48,
            "name": "NO routes under /auth/* exist",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 49,
            "name": "decorator \"authenticate\" is available",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 50,
            "name": "decorator \"keycloak\" is available",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 51,
            "name": "decorator \"session\" is available",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;use-authenticate-decorator-in-protected-route",
        "keyword": "Scenario",
        "line": 53,
        "name": "Use authenticate decorator in protected route",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 54,
            "name": "the auth plugin is registered in gateway",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "fastify.get('/api/profile', {\n  onRequest: [fastify.authenticate]\n}, async (request) => {\n  return { user: request.user };\n});",
                "line": 56
              }
            ],
            "keyword": "And ",
            "line": 55,
            "name": "a route is defined:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 63,
            "name": "I call GET /api/profile without Authorization header",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 64,
            "name": "response status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 65,
            "name": "I call GET /api/profile with valid JWT",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 66,
            "name": "response status is 200",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 67,
            "name": "response body includes user data from JWT",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;missing-required-option---keycloakurl",
        "keyword": "Scenario",
        "line": 69,
        "name": "Missing required option - keycloakUrl",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 70,
            "name": "a Fastify instance",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"realm\": \"techcitizen\",\n  \"clientId\": \"gateway\"\n}",
                "line": 72
              }
            ],
            "keyword": "When ",
            "line": 71,
            "name": "I register plugin without keycloakUrl:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 78,
            "name": "plugin throws error",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 79,
            "name": "error message is \"Missing required option: keycloakUrl\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;missing-required-option---realm",
        "keyword": "Scenario",
        "line": 81,
        "name": "Missing required option - realm",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 82,
            "name": "a Fastify instance",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"keycloakUrl\": \"http://localhost:8080\",\n  \"clientId\": \"gateway\"\n}",
                "line": 84
              }
            ],
            "keyword": "When ",
            "line": 83,
            "name": "I register plugin without realm:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 90,
            "name": "plugin throws error",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 91,
            "name": "error message is \"Missing required option: realm\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;optional-redis-url-defaults-to-in-memory-storage",
        "keyword": "Scenario",
        "line": 93,
        "name": "Optional Redis URL defaults to in-memory storage",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 94,
            "name": "a Fastify instance",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"keycloakUrl\": \"http://localhost:8080\",\n  \"realm\": \"techcitizen\",\n  \"clientId\": \"gateway\",\n  \"enableRoutes\": false\n}",
                "line": 96
              }
            ],
            "keyword": "When ",
            "line": 95,
            "name": "I register plugin without redisUrl:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 104,
            "name": "plugin registers successfully",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 105,
            "name": "session storage uses in-memory Map (warning logged)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 106,
            "name": "session.validateRefreshToken still works",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "But ",
            "line": 107,
            "name": "sessions are NOT persisted across restarts",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;plugin-name-and-version-metadata",
        "keyword": "Scenario",
        "line": 109,
        "name": "Plugin name and version metadata",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 110,
            "name": "the auth plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 111,
            "name": "I inspect registered plugins",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 112,
            "name": "plugin name is \"@tech-citizen/auth\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 113,
            "name": "plugin fastify version is \"5.x\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 114,
            "name": "plugin is wrapped with fastify-plugin",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;multiple-services-register-same-plugin-independently",
        "keyword": "Scenario",
        "line": 116,
        "name": "Multiple services register same plugin independently",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 117,
            "name": "auth-api service registers plugin with enableRoutes=true",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 118,
            "name": "gateway service registers plugin with enableRoutes=false",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 119,
            "name": "patient-api service registers plugin with enableRoutes=false",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 120,
            "name": "all services start in Platformatic Watt",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 121,
            "name": "each service has independent plugin instance",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 122,
            "name": "auth-api exposes /auth/* routes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 123,
            "name": "gateway and patient-api do NOT expose /auth/* routes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 124,
            "name": "all services can validate JWT tokens independently",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;plugin-provides-typebox-schemas-for-external-use",
        "keyword": "Scenario",
        "line": 126,
        "name": "Plugin provides TypeBox schemas for external use",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 127,
            "name": "the auth plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "import { RegisterUserSchema, LoginUserSchema, TokenResponseSchema } from '@tech-citizen/auth';",
                "line": 129
              }
            ],
            "keyword": "When ",
            "line": 128,
            "name": "I import schemas from \"@tech-citizen/auth\":",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 132,
            "name": "schemas are available for reuse",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 133,
            "name": "I can use schemas in custom routes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 134,
            "name": "schemas are already compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;plugin-initialization-with-keycloak-unavailable",
        "keyword": "Scenario",
        "line": 136,
        "name": "Plugin initialization with Keycloak unavailable",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 137,
            "name": "Keycloak container is stopped",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 138,
            "name": "I register the auth plugin",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 139,
            "name": "plugin initialization fails after retries",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 140,
            "name": "error code is \"KEYCLOAK_UNAVAILABLE\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 141,
            "name": "error message contains \"Cannot connect to Keycloak\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 142,
            "name": "Fastify app does not start",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "auth-plugin-registration-and-configuration;hot-reload-support-in-development",
        "keyword": "Scenario",
        "line": 144,
        "name": "Hot reload support in development",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "a Fastify instance is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "Keycloak is running at \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 145,
            "name": "Platformatic Watt is running in dev mode",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 146,
            "name": "auth plugin is registered in auth-api",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 147,
            "name": "I modify packages/auth/src/plugins/jwt.ts",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 148,
            "name": "Watt detects file change",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 149,
            "name": "auth-api service restarts",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 150,
            "name": "plugin is re-registered with new code",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 151,
            "name": "no manual restart is needed",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      }
    ],
    "id": "auth-plugin-registration-and-configuration",
    "line": 1,
    "keyword": "Feature",
    "name": "Auth Plugin Registration and Configuration",
    "tags": [],
    "uri": "e2e/features/auth-plugin-registration.feature"
  },
  {
    "description": "  As a developer\n  I want to validate authentication requests with TypeBox schemas\n  So that invalid data is rejected before reaching business logic",
    "elements": [
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;valid-registration-data-passes-validation",
        "keyword": "Scenario",
        "line": 17,
        "name": "Valid registration data passes validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 18,
            "name": "RegisterUserSchema compiled validator",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"SecureP@ss1\"\n}",
                "line": 20
              }
            ],
            "keyword": "When ",
            "line": 19,
            "name": "I validate the following data:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 26,
            "name": "validation passes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 27,
            "name": "TypeScript infers type RegisterUser",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 28,
            "name": "no errors are returned",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;invalid-email-format-fails-validation",
        "keyword": "Scenario",
        "line": 30,
        "name": "Invalid email format fails validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 31,
            "name": "RegisterUserSchema compiled validator",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"email\": \"not-an-email\",\n  \"password\": \"SecureP@ss1\"\n}",
                "line": 33
              }
            ],
            "keyword": "When ",
            "line": 32,
            "name": "I validate the following data:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 39,
            "name": "validation fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 40,
            "name": "error path is \"/email\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 41,
            "name": "error message is \"must match format \\\"email\\\"\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;password-too-short-fails-validation",
        "keyword": "Scenario",
        "line": 43,
        "name": "Password too short fails validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 44,
            "name": "RegisterUserSchema compiled validator",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"Short1\"\n}",
                "line": 46
              }
            ],
            "keyword": "When ",
            "line": 45,
            "name": "I validate the following data:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 52,
            "name": "validation fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 53,
            "name": "error path is \"/password\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 54,
            "name": "error message contains \"must NOT have fewer than 8 characters\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;password-missing-uppercase-letter-fails-validation",
        "keyword": "Scenario",
        "line": 56,
        "name": "Password missing uppercase letter fails validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 57,
            "name": "RegisterUserSchema with password pattern /(?=.*[A-Z])(?=.*\\d)/",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"lowercase123\"\n}",
                "line": 59
              }
            ],
            "keyword": "When ",
            "line": 58,
            "name": "I validate the following data:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 65,
            "name": "validation fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 66,
            "name": "error path is \"/password\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 67,
            "name": "error message contains \"must match pattern\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;password-missing-number-fails-validation",
        "keyword": "Scenario",
        "line": 69,
        "name": "Password missing number fails validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 70,
            "name": "RegisterUserSchema with password pattern /(?=.*[A-Z])(?=.*\\d)/",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"NoNumbersHere\"\n}",
                "line": 72
              }
            ],
            "keyword": "When ",
            "line": 71,
            "name": "I validate the following data:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 78,
            "name": "validation fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 79,
            "name": "error path is \"/password\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 80,
            "name": "error message contains \"must match pattern\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;missing-required-field-fails-validation",
        "keyword": "Scenario",
        "line": 82,
        "name": "Missing required field fails validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 83,
            "name": "RegisterUserSchema compiled validator",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"email\": \"test@example.com\"\n}",
                "line": 85
              }
            ],
            "keyword": "When ",
            "line": 84,
            "name": "I validate the following data:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 90,
            "name": "validation fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 91,
            "name": "error path is \"\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 92,
            "name": "error message is \"must have required property 'password'\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;extra-fields-are-ignored-(additionalproperties:-false)",
        "keyword": "Scenario",
        "line": 94,
        "name": "Extra fields are ignored (additionalProperties: false)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 95,
            "name": "RegisterUserSchema with additionalProperties: false",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"email\": \"test@example.com\",\n  \"password\": \"SecureP@ss1\",\n  \"extraField\": \"should be ignored\"\n}",
                "line": 97
              }
            ],
            "keyword": "When ",
            "line": 96,
            "name": "I validate the following data:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 104,
            "name": "validation fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 105,
            "name": "error message contains \"must NOT have additional properties\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;valid-login-data-passes-validation",
        "keyword": "Scenario",
        "line": 107,
        "name": "Valid login data passes validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 108,
            "name": "LoginUserSchema compiled validator",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"email\": \"user@example.com\",\n  \"password\": \"anypassword\"\n}",
                "line": 110
              }
            ],
            "keyword": "When ",
            "line": 109,
            "name": "I validate the following data:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 116,
            "name": "validation passes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 117,
            "name": "TypeScript infers type LoginUser",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;token-response-schema-validation",
        "keyword": "Scenario",
        "line": 119,
        "name": "Token response schema validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "accessToken",
                      "string, minLength 1"
                    ]
                  },
                  {
                    "cells": [
                      "refreshToken",
                      "string, minLength 1"
                    ]
                  },
                  {
                    "cells": [
                      "expiresIn",
                      "number, minimum 0"
                    ]
                  },
                  {
                    "cells": [
                      "tokenType",
                      "string, const \"Bearer\""
                    ]
                  }
                ]
              }
            ],
            "keyword": "Given ",
            "line": 120,
            "name": "TokenResponseSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"accessToken\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...\",\n  \"refreshToken\": \"refresh-token-xyz\",\n  \"expiresIn\": 300,\n  \"tokenType\": \"Bearer\"\n}",
                "line": 127
              }
            ],
            "keyword": "When ",
            "line": 126,
            "name": "I validate the following token response:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 135,
            "name": "validation passes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 136,
            "name": "TypeScript infers type TokenResponse",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;invalid-token-type-fails-validation",
        "keyword": "Scenario",
        "line": 138,
        "name": "Invalid token type fails validation",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 139,
            "name": "TokenResponseSchema with tokenType const \"Bearer\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 140,
            "name": "I validate token response with tokenType \"Basic\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 141,
            "name": "validation fails",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 142,
            "name": "error path is \"/tokenType\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 143,
            "name": "error message is \"must be equal to constant\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;performance-test---compiled-validator-is-fast",
        "keyword": "Scenario",
        "line": 145,
        "name": "Performance test - compiled validator is fast",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 146,
            "name": "RegisterUserSchema compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 147,
            "name": "I validate 1000 requests with valid data",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 148,
            "name": "total time is less than 10 milliseconds",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 149,
            "name": "average time per validation is less than 0.01ms",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 150,
            "name": "performance is 10-100x faster than class-validator",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "typebox-schema-validation-for-auth-requests;openapi-schema-generation-from-typebox",
        "keyword": "Scenario",
        "line": 152,
        "name": "OpenAPI schema generation from TypeBox",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "TypeBox schemas are compiled with TypeCompiler",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 8, pattern (1 upper, 1 number)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 8,
            "name": "RegisterUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "rule"
                    ]
                  },
                  {
                    "cells": [
                      "email",
                      "string, format email"
                    ]
                  },
                  {
                    "cells": [
                      "password",
                      "string, minLength 1"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 12,
            "name": "LoginUserSchema requires:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 153,
            "name": "RegisterUserSchema defined with TypeBox",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 154,
            "name": "I generate OpenAPI schema using Type.Strict()",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 155,
            "name": "OpenAPI schema is generated automatically",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "content": "{\n  \"type\": \"object\",\n  \"required\": [\"email\", \"password\"],\n  \"properties\": {\n    \"email\": { \"type\": \"string\", \"format\": \"email\" },\n    \"password\": { \"type\": \"string\", \"minLength\": 8 }\n  }\n}",
                "line": 157
              }
            ],
            "keyword": "And ",
            "line": 156,
            "name": "schema includes:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 167,
            "name": "schema can be used in Fastify route schema",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 168,
            "name": "Swagger UI shows correct validation rules",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      }
    ],
    "id": "typebox-schema-validation-for-auth-requests",
    "line": 1,
    "keyword": "Feature",
    "name": "TypeBox Schema Validation for Auth Requests",
    "tags": [],
    "uri": "e2e/features/auth-schema-validation.feature"
  },
  {
    "description": "  As a security engineer\n  I want to manage user sessions with refresh token rotation\n  So that I can prevent token theft and enable secure logout",
    "elements": [
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;store-refresh-token-successfully",
        "keyword": "Scenario",
        "line": 14,
        "name": "Store refresh token successfully",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "userId",
                      "user-123"
                    ]
                  },
                  {
                    "cells": [
                      "tokenId",
                      "refresh-abc-456"
                    ]
                  },
                  {
                    "cells": [
                      "exp",
                      "2025-12-10T00:00:00Z (24h later)"
                    ]
                  }
                ]
              }
            ],
            "keyword": "Given ",
            "line": 15,
            "name": "a valid refresh token with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 20,
            "name": "I call session.storeRefreshToken(token, \"user-123\")",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 21,
            "name": "the token is stored in Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 22,
            "name": "Redis key is \"refresh:user-123:refresh-abc-456\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 23,
            "name": "TTL equals 86400 seconds (24 hours)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 24,
            "name": "subsequent session.validateRefreshToken(token) returns true",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;validate-active-refresh-token",
        "keyword": "Scenario",
        "line": 26,
        "name": "Validate active refresh token",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 27,
            "name": "a refresh token stored in Redis with userId \"user-123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 28,
            "name": "I call session.validateRefreshToken(token)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 29,
            "name": "validation returns true",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 30,
            "name": "token data includes userId \"user-123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;validate-non-existent-refresh-token",
        "keyword": "Scenario",
        "line": 32,
        "name": "Validate non-existent refresh token",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 33,
            "name": "no refresh token exists in Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 34,
            "name": "I call session.validateRefreshToken(\"non-existent-token\")",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 35,
            "name": "validation returns false",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 36,
            "name": "no error is thrown",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;revoke-refresh-token-(logout)",
        "keyword": "Scenario",
        "line": 38,
        "name": "Revoke refresh token (logout)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "field",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "userId",
                      "user-123"
                    ]
                  },
                  {
                    "cells": [
                      "tokenId",
                      "refresh-xyz-789"
                    ]
                  },
                  {
                    "cells": [
                      "exp",
                      "24h from now"
                    ]
                  }
                ]
              }
            ],
            "keyword": "Given ",
            "line": 39,
            "name": "an active refresh token with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 44,
            "name": "I call session.revokeToken(token)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 45,
            "name": "the token is added to blacklist",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 46,
            "name": "Redis key \"blacklist:refresh-xyz-789\" is created",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 47,
            "name": "blacklist entry TTL equals token exp - current time",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 48,
            "name": "subsequent session.validateRefreshToken(token) returns false",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 49,
            "name": "the original refresh token key is deleted",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;rotate-tokens-(refresh-endpoint)",
        "keyword": "Scenario",
        "line": 51,
        "name": "Rotate tokens (refresh endpoint)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 52,
            "name": "a valid refresh token with userId \"user-123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 53,
            "name": "I call session.rotateTokens(oldRefreshToken)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 54,
            "name": "a new access token is generated",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 55,
            "name": "a new refresh token is generated",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 56,
            "name": "the old refresh token is revoked (added to blacklist)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 57,
            "name": "the new refresh token is stored in Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 58,
            "name": "the new access token expires in 5 minutes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 59,
            "name": "the new refresh token expires in 24 hours",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;attempt-to-use-revoked-token",
        "keyword": "Scenario",
        "line": 61,
        "name": "Attempt to use revoked token",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 62,
            "name": "a refresh token that was revoked 1 hour ago",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 63,
            "name": "I call session.validateRefreshToken(revokedToken)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 64,
            "name": "validation returns false",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 65,
            "name": "error message is \"Token has been revoked\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;token-blacklist-cleanup-after-expiration",
        "keyword": "Scenario",
        "line": 67,
        "name": "Token blacklist cleanup after expiration",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 68,
            "name": "a revoked token with exp = 1 hour ago",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 69,
            "name": "the token was added to blacklist when revoked",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 70,
            "name": "Redis TTL expires (1 hour passes)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 71,
            "name": "the blacklist entry is automatically deleted by Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 72,
            "name": "no manual cleanup is required",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;concurrent-token-rotation-prevention",
        "keyword": "Scenario",
        "line": 74,
        "name": "Concurrent token rotation prevention",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 75,
            "name": "a valid refresh token with userId \"user-123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 76,
            "name": "two requests call session.rotateTokens(sameToken) simultaneously",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 77,
            "name": "only one rotation succeeds",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 78,
            "name": "the other request receives error \"TOKEN_ALREADY_ROTATED\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 79,
            "name": "only one new refresh token exists in Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;redis-connection-failure-handling",
        "keyword": "Scenario",
        "line": 81,
        "name": "Redis connection failure handling",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 82,
            "name": "Redis container is stopped",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 83,
            "name": "I call session.storeRefreshToken(token, userId)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 84,
            "name": "the operation retries 3 times",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 85,
            "name": "after retries, error is thrown",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 86,
            "name": "error code is \"REDIS_UNAVAILABLE\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;store-multiple-refresh-tokens-for-same-user-(multi-device)",
        "keyword": "Scenario",
        "line": 88,
        "name": "Store multiple refresh tokens for same user (multi-device)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 89,
            "name": "user \"user-123\" has no active tokens",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 90,
            "name": "I store refresh token A with tokenId \"token-A\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 91,
            "name": "I store refresh token B with tokenId \"token-B\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "key"
                    ]
                  },
                  {
                    "cells": [
                      "refresh:user-123:token-A"
                    ]
                  },
                  {
                    "cells": [
                      "refresh:user-123:token-B"
                    ]
                  }
                ]
              }
            ],
            "keyword": "Then ",
            "line": 92,
            "name": "both tokens exist in Redis:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 96,
            "name": "both tokens can be validated independently",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "session-management-with-refresh-tokens;revoke-all-user-sessions-(logout-from-all-devices)",
        "keyword": "Scenario",
        "line": 98,
        "name": "Revoke all user sessions (logout from all devices)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 7,
            "name": "Redis is running at \"redis://localhost:6379\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 8,
            "name": "the auth package session plugin is registered",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [
              {
                "rows": [
                  {
                    "cells": [
                      "setting",
                      "value"
                    ]
                  },
                  {
                    "cells": [
                      "accessTokenTTL",
                      "300 seconds"
                    ]
                  },
                  {
                    "cells": [
                      "refreshTokenTTL",
                      "86400 seconds"
                    ]
                  }
                ]
              }
            ],
            "keyword": "And ",
            "line": 9,
            "name": "Keycloak is configured with:",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 99,
            "name": "user \"user-123\" has 3 active refresh tokens",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 100,
            "name": "I call session.revokeAllUserTokens(\"user-123\")",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 101,
            "name": "all 3 tokens are added to blacklist",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 102,
            "name": "all 3 original refresh token keys are deleted",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 103,
            "name": "subsequent validation of any token returns false",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      }
    ],
    "id": "session-management-with-refresh-tokens",
    "line": 1,
    "keyword": "Feature",
    "name": "Session Management with Refresh Tokens",
    "tags": [],
    "uri": "e2e/features/auth-session-management.feature"
  },
  {
    "description": "  Come utente autenticato\n  Voglio che il sistema rinnovi automaticamente i miei token\n  Per mantenere la sessione attiva senza re-login",
    "elements": [
      {
        "description": "",
        "id": "refresh-automatico-token-e-gestione-sessione;token-refresh-automatico-quando-in-scadenza",
        "keyword": "Scenario",
        "line": 13,
        "name": "Token refresh automatico quando in scadenza",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che l'utente ha effettuato login",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:131"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che la sessione  attiva",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:9"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 14,
            "name": "che il token scade tra 4 minuti",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:15"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 15,
            "name": "l'utente accede a \"/api/protected\"",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:56"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 16,
            "name": "il sistema effettua refresh del token automaticamente",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 17,
            "name": "la richiesta ha successo",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:242"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 18,
            "name": "la sessione viene aggiornata con il nuovo token",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:88"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "refresh-automatico-token-e-gestione-sessione;estensione-ttl-sessione-con-sliding-window",
        "keyword": "Scenario",
        "line": 20,
        "name": "Estensione TTL sessione con sliding window",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che l'utente ha effettuato login",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:131"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che la sessione  attiva",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:9"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 21,
            "name": "che la sessione ha TTL 30 minuti",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:22"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 22,
            "name": "che l'ultimo accesso  avvenuto 2 minuti fa",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:29"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 23,
            "name": "l'utente accede a \"/api/protected\"",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:56"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 24,
            "name": "il TTL della sessione viene esteso a 30 minuti",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:95"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 25,
            "name": "l'ultimo accesso viene aggiornato",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:104"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "refresh-automatico-token-e-gestione-sessione;sessione-scaduta",
        "keyword": "Scenario",
        "line": 27,
        "name": "Sessione scaduta",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che l'utente ha effettuato login",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:131"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che la sessione  attiva",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:9"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 28,
            "name": "che la sessione  scaduta",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:38"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 29,
            "name": "l'utente accede a \"/api/protected\"",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:56"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 30,
            "name": "la richiesta fallisce",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:246"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 31,
            "name": "riceve status 401",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:250"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 32,
            "name": "riceve messaggio \"Session expired\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:254"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 33,
            "name": "la sessione viene rimossa da Redis",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:112"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "refresh-automatico-token-e-gestione-sessione;refresh-token-invalido",
        "keyword": "Scenario",
        "line": 35,
        "name": "Refresh token invalido",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che l'utente ha effettuato login",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:131"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che la sessione  attiva",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:9"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 36,
            "name": "che il refresh token  scaduto",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:44"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 37,
            "name": "l'utente accede a \"/api/protected\"",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:56"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 38,
            "name": "il sistema tenta il refresh",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:118"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 39,
            "name": "il refresh fallisce",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:124"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 40,
            "name": "riceve status 401",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:250"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 41,
            "name": "riceve messaggio \"Token refresh failed\"",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:254"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 42,
            "name": "la sessione viene invalidata",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:128"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "refresh-automatico-token-e-gestione-sessione;logout-utente",
        "keyword": "Scenario",
        "line": 44,
        "name": "Logout utente",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 9,
            "name": "che il gateway  in esecuzione",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:76"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 10,
            "name": "che l'utente ha effettuato login",
            "match": {
              "location": "e2e/steps/auth-login.steps.ts:131"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 11,
            "name": "che la sessione  attiva",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:9"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Dato ",
            "line": 45,
            "name": "che l'utente ha una sessione attiva",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:49"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Quando ",
            "line": 46,
            "name": "l'utente effettua logout",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:65"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Allora ",
            "line": 47,
            "name": "il logout ha successo",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:134"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 48,
            "name": "la sessione viene rimossa da Redis",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:112"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 49,
            "name": "i token vengono invalidati",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:138"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "E ",
            "line": 50,
            "name": "tentativi successivi di accesso falliscono",
            "match": {
              "location": "e2e/steps/auth-session-refresh.steps.ts:146"
            },
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      }
    ],
    "id": "refresh-automatico-token-e-gestione-sessione",
    "line": 2,
    "keyword": "Funzionalit",
    "name": "Refresh automatico token e gestione sessione",
    "tags": [],
    "uri": "e2e/features/auth-session-refresh.feature"
  },
  {
    "description": "  As a healthcare application\n  I want to authenticate users via Keycloak OIDC\n  So that users can login with SSO and auto-provision on first access",
    "elements": [
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);user-logs-in-via-oidc-for-the-first-time-(auto-provisioning)",
        "keyword": "Scenario",
        "line": 13,
        "name": "User logs in via OIDC for the first time (auto-provisioning)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 14,
            "name": "user \"john.doe@example.com\" does not exist in Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 15,
            "name": "user navigates to \"/auth/login\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 16,
            "name": "user is redirected to Keycloak login page",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 17,
            "name": "user enters valid credentials",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 18,
            "name": "user completes authentication",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 19,
            "name": "user is created in Keycloak with attribute \"user_type=domain\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 20,
            "name": "user is redirected to \"/auth/callback\" with authorization code",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 21,
            "name": "authorization code is exchanged for tokens",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 22,
            "name": "session is created in Redis with \"requestId\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 23,
            "name": "user is redirected to dashboard",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);user-logs-in-via-oidc-(existing-user)",
        "keyword": "Scenario",
        "line": 25,
        "name": "User logs in via OIDC (existing user)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 26,
            "name": "user \"jane.smith@example.com\" exists in Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 27,
            "name": "user navigates to \"/auth/login\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 28,
            "name": "user is redirected to Keycloak login page",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 29,
            "name": "user enters valid credentials",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 30,
            "name": "authorization code is returned to \"/auth/callback\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 31,
            "name": "tokens are exchanged and validated",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 32,
            "name": "session is created with user attributes",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 33,
            "name": "user is redirected to dashboard",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);oidc-callback-receives-valid-authorization-code",
        "keyword": "Scenario",
        "line": 35,
        "name": "OIDC callback receives valid authorization code",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 36,
            "name": "a valid authorization code from Keycloak",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 37,
            "name": "the code is sent to \"/auth/callback?code=VALID_CODE&state=STATE_TOKEN\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 38,
            "name": "the gateway exchanges code for tokens",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 39,
            "name": "access_token is validated (signature, expiration, issuer)",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 40,
            "name": "refresh_token is stored securely",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 41,
            "name": "session cookie is set with httpOnly and secure flags",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 42,
            "name": "user is redirected to \"/\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);oidc-callback-receives-invalid-authorization-code",
        "keyword": "Scenario",
        "line": 44,
        "name": "OIDC callback receives invalid authorization code",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 45,
            "name": "an invalid authorization code",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 46,
            "name": "the code is sent to \"/auth/callback?code=INVALID_CODE\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 47,
            "name": "the response status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 48,
            "name": "error message is \"Invalid authorization code\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 49,
            "name": "user is redirected to \"/auth/login?error=invalid_code\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);user-logs-out-(session-destruction)",
        "keyword": "Scenario",
        "line": 51,
        "name": "User logs out (session destruction)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 52,
            "name": "user is authenticated with session ID \"abc123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 53,
            "name": "user requests \"/auth/logout\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 54,
            "name": "session \"abc123\" is deleted from Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 55,
            "name": "user is redirected to Keycloak logout endpoint",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 56,
            "name": "Keycloak invalidates tokens",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 57,
            "name": "user is redirected to \"/\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);access-protected-route-without-session",
        "keyword": "Scenario",
        "line": 59,
        "name": "Access protected route without session",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 60,
            "name": "user is not authenticated",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 61,
            "name": "user requests \"/api/protected-resource\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 62,
            "name": "the response status is 401",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 63,
            "name": "error message is \"Authentication required\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 64,
            "name": "user is redirected to \"/auth/login\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);access-protected-route-with-valid-session",
        "keyword": "Scenario",
        "line": 66,
        "name": "Access protected route with valid session",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 67,
            "name": "user is authenticated with session ID \"xyz789\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 68,
            "name": "session \"xyz789\" exists in Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 69,
            "name": "user requests \"/api/protected-resource\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 70,
            "name": "the request includes session data in context",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 71,
            "name": "the response status is 200",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);token-refresh-when-access_token-expires",
        "keyword": "Scenario",
        "line": 73,
        "name": "Token refresh when access_token expires",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 74,
            "name": "user has expired access_token",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 75,
            "name": "user has valid refresh_token",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 76,
            "name": "the gateway detects token expiration",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 77,
            "name": "refresh_token is sent to Keycloak \"/token\" endpoint",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 78,
            "name": "new access_token and refresh_token are received",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 79,
            "name": "session is updated with new tokens",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 80,
            "name": "request proceeds with new access_token",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);session-expires-(redis-ttl-exceeded)",
        "keyword": "Scenario",
        "line": 82,
        "name": "Session expires (Redis TTL exceeded)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 83,
            "name": "user has session ID \"expired123\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 84,
            "name": "session TTL has expired in Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 85,
            "name": "user requests protected route",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 86,
            "name": "session is not found in Redis",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 87,
            "name": "user is redirected to \"/auth/login\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 88,
            "name": "error message is \"Session expired, please login again\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);validate-jwt-issuer-matches-keycloak-realm",
        "keyword": "Scenario",
        "line": 90,
        "name": "Validate JWT issuer matches Keycloak realm",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 91,
            "name": "access_token has issuer \"http://keycloak:8080/realms/WRONG_REALM\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 92,
            "name": "token is validated",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 93,
            "name": "validation fails with \"Invalid issuer\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 94,
            "name": "user is logged out",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      },
      {
        "description": "",
        "id": "keycloak-oidc-authentication-(us-039);validate-required-claims-in-jwt-(email,-sub)",
        "keyword": "Scenario",
        "line": 96,
        "name": "Validate required claims in JWT (email, sub)",
        "steps": [
          {
            "keyword": "Before",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 8,
            "name": "Keycloak is running on \"http://localhost:8080\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 9,
            "name": "realm \"healthcare-domain\" exists",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 10,
            "name": "OIDC client \"gateway-client\" is configured",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 11,
            "name": "client secret is set in environment variables",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Given ",
            "line": 97,
            "name": "access_token is missing \"email\" claim",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "When ",
            "line": 98,
            "name": "token is validated",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "Then ",
            "line": 99,
            "name": "validation fails with \"Missing required claim: email\"",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "arguments": [],
            "keyword": "And ",
            "line": 100,
            "name": "session creation is aborted",
            "result": {
              "status": "undefined",
              "duration": 0
            }
          },
          {
            "keyword": "After",
            "hidden": true,
            "result": {
              "status": "skipped",
              "duration": 0
            }
          }
        ],
        "tags": [],
        "type": "scenario"
      }
    ],
    "id": "keycloak-oidc-authentication-(us-039)",
    "line": 1,
    "keyword": "Feature",
    "name": "Keycloak OIDC Authentication (US-039)",
    "tags": [],
    "uri": "e2e/features/keycloak-oidc-auth.feature"
  }
]