#!/bin/sh

# Carica configurazione
HUSKY_CONFIG=".husky-config.json"

if [ -f "$HUSKY_CONFIG" ]; then
  ENABLED=$(node -p "require('./$HUSKY_CONFIG').enabled")
  PRE_COMMIT_ENABLED=$(node -p "require('./$HUSKY_CONFIG').hooks['pre-commit'].enabled")
  RUN_LINT_STAGED=$(node -p "require('./$HUSKY_CONFIG').hooks['pre-commit'].runLintStaged")
  
  if [ "$ENABLED" = "false" ] || [ "$PRE_COMMIT_ENABLED" = "false" ]; then
    echo "â­ï¸  Pre-commit hook disabled in .husky-config.json"
    exit 0
  fi
fi

echo "ğŸ” Running pre-commit checks..."

# Update features.json from git commits
echo "ğŸ“Š Updating features.json from commits..."
npm run features:update --silent
git add features.json

# Validate features.json schema
echo "ğŸ” Validating features.json schema..."
npm run features:validate --silent || {
  echo "âŒ features.json validation failed!"
  echo "   Run 'npm run features:validate' to see errors"
  exit 1
}

# Lint staged files
if [ "$RUN_LINT_STAGED" != "false" ]; then
  echo "ğŸ“ Formatting and linting staged files..."
  npx lint-staged
fi

# Check for secrets
echo "ğŸ” Checking for hardcoded secrets..."
node scripts/check-secrets.cjs

echo "âœ… Pre-commit checks passed!"
